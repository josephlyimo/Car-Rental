<h2>Book a Car</h2>

<form id="bookingForm">
  {{#if car}}
    <p>Car Name: {{car.name}}</p>
    <p>Car Color: {{car.color}}</p>
    <p>Car Type: {{car.type}}</p>
    <input type="hidden" id="car_id" name="car_id" value="{{car.id}}" />
    <p>Purpose: {{car.type}}</p>
    <input type="hidden" id="purpose" name="purpose" value="{{car.type}}" />
  {{else}}
    {{#with cars.[0]}}
      <p>Car Name: {{name}}</p>
      <p>Car Color: {{color}}</p>
      <p>Car Type: {{type}}</p>
      <input type="hidden" id="car_id" name="car_id" value="{{id}}" />
      <p>Purpose: {{type}}</p>
      <input type="hidden" id="purpose" name="purpose" value="{{type}}" />
    {{/with}}
  {{/if}}

  {{#unless car}}
  {{!-- This block is now redundant because the else block above handles the no car case --}}
  {{/unless}}

  <label for="start_date">Start Date:</label>
  <input type="date" id="start_date" name="start_date" required min="{{today}}">

  <label for="end_date">End Date:</label>
  <input type="date" id="end_date" name="end_date" required min="{{today}}">

  <button type="submit">Book Now</button>
</form>

<div id="notification" style="display:none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #4caf50; color: white; padding: 10px; border-radius: 5px; z-index: 1000;"></div>

<script>
  function showNotification(message, isError = false) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.style.backgroundColor = isError ? '#f44336' : '#4caf50';
    notification.style.display = 'block';
    setTimeout(() => {
      notification.style.display = 'none';
    }, 5000);
  }

  const bookingForm = document.getElementById('bookingForm');
  bookingForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(bookingForm);
    const data = {
      car_id: formData.get('car_id'),
      purpose: formData.get('purpose'),
      start_date: formData.get('start_date'),
      end_date: formData.get('end_date')
    };

    try {
      const response = await fetch('/bookings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (response.ok) {
        showNotification('Booking created successfully!');
        setTimeout(() => {
          window.location.href = '/bookings/history';
        }, 5000);
      } else {
        const resData = await response.json();
        showNotification('Error: ' + resData.message, true);
      }
    } catch (err) {
      showNotification('Error: ' + err.message, true);
    }
  });
</script>
