<h2>Available Cars</h2>

<div>
  
  <script>
    const searchInput = document.getElementById('searchInput');
    const suggestionsBox = document.getElementById('suggestions');
    const searchForm = document.getElementById('searchForm');

    searchInput.addEventListener('input', async () => {
      const query = searchInput.value.trim();
      console.log('Search input changed:', query);
      if (query.length === 0) {
        suggestionsBox.style.display = 'none';
        suggestionsBox.innerHTML = '';
        return;
      }
      try {
        const response = await fetch(`/cars/search-suggestions?q=${encodeURIComponent(query)}`);
        console.log('Fetch response status:', response.status);
        const suggestions = await response.json();
        console.log('Suggestions received:', suggestions);
        if (suggestions.length === 0) {
          suggestionsBox.style.display = 'none';
          suggestionsBox.innerHTML = '';
          return;
        }
        suggestionsBox.innerHTML = suggestions.map(s => `<div class="suggestion-item" style="padding: 5px; cursor: pointer;">${s}</div>`).join('');
        suggestionsBox.style.display = 'block';

        document.querySelectorAll('.suggestion-item').forEach(item => {
          item.addEventListener('click', () => {
            searchInput.value = item.textContent;
            suggestionsBox.style.display = 'none';
            suggestionsBox.innerHTML = '';
          });
        });
      } catch (err) {
        console.error('Error fetching suggestions:', err);
        suggestionsBox.style.display = 'none';
        suggestionsBox.innerHTML = '';
      }
    });

    document.addEventListener('click', (e) => {
      if (!suggestionsBox.contains(e.target) && e.target !== searchInput) {
        suggestionsBox.style.display = 'none';
        suggestionsBox.innerHTML = '';
      }
    });

    searchForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const query = searchInput.value.trim();
      if (query.length > 0) {
        window.location.href = `/search?query=${encodeURIComponent(query)}`;
      }
    });
  </script>
</div>

  {{#if user}}
  {{#if (eq user.role "user")}}
    <!--<div class="mb-20">
      <a href="/bookings/new" class="btn btn-primary">Continue Booking</a>
    </div>-->
  {{else if (eq user.role "admin")}}
    <div class="mb-20">
      <a href="/bookings/history" class="btn btn-secondary">View Bookings</a>
    </div>
  {{/if}}
{{/if}}

<div id="car-list">
  <div id="car-listings" class="car-grid">
    {{#if loading}}
      <div class="loading-container">
        <div class="loading-spinner"></div>
      </div>
      {{else}}
      {{#each cars}}
        {{> carCard this}}
      {{/each}}
    {{/if}}
  </div>

  {{!-- Or for skeleton loading --}}
  <div id="car-listings" class="car-grid">
    {{#if loading}}
      {{#each (repeat 6)}}
        <div class="car-card skeleton skeleton-card">
          <div class="skeleton skeleton-text short"></div>
          <div class="skeleton skeleton-text medium"></div>
          <div class="skeleton skeleton-text"></div>
        </div>
      {{/each}}
    {{else}}
      {{#each cars}}
        {{> carCard this}}
      {{/each}}
    {{/if}}
  </div>
</div>

<script>
  document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const color = document.getElementById('color').value;
    const type = document.getElementById('type').value;
    let query = '?';
    if (color) query += 'color=' + encodeURIComponent(color) + '&';
    if (type) query += 'type=' + encodeURIComponent(type) + '&';
    window.location.href = '/' + query.slice(0, -1);
  });
</script>
