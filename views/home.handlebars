<h2>Available Cars</h2>

<div>
  
  <script>
    const searchInput = document.getElementById('searchInput');
    const suggestionsBox = document.getElementById('suggestions');
    const searchForm = document.getElementById('searchForm');

    searchInput.addEventListener('input', async () => {
      const query = searchInput.value.trim();
      console.log('Search input changed:', query);
      if (query.length === 0) {
        suggestionsBox.style.display = 'none';
        suggestionsBox.innerHTML = '';
        return;
      }
      try {
        const response = await fetch(`/cars/search-suggestions?q=${encodeURIComponent(query)}`);
        console.log('Fetch response status:', response.status);
        const suggestions = await response.json();
        console.log('Suggestions received:', suggestions);
        if (suggestions.length === 0) {
          suggestionsBox.style.display = 'none';
          suggestionsBox.innerHTML = '';
          return;
        }
        suggestionsBox.innerHTML = suggestions.map(s => `<div class="suggestion-item" style="padding: 5px; cursor: pointer;">${s}</div>`).join('');
        suggestionsBox.style.display = 'block';

        document.querySelectorAll('.suggestion-item').forEach(item => {
          item.addEventListener('click', () => {
            searchInput.value = item.textContent;
            suggestionsBox.style.display = 'none';
            suggestionsBox.innerHTML = '';
          });
        });
      } catch (err) {
        console.error('Error fetching suggestions:', err);
        suggestionsBox.style.display = 'none';
        suggestionsBox.innerHTML = '';
      }
    });

    document.addEventListener('click', (e) => {
      if (!suggestionsBox.contains(e.target) && e.target !== searchInput) {
        suggestionsBox.style.display = 'none';
        suggestionsBox.innerHTML = '';
      }
    });

    searchForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const query = searchInput.value.trim();
      if (query.length > 0) {
        window.location.href = `/search?query=${encodeURIComponent(query)}`;
      }
    });
  </script>
</div>

  {{#if user}}
  {{#if (eq user.role "user")}}
    <div class="mb-20">
      <a href="/bookings/new" class="btn btn-primary">Continue Booking</a>
    </div>
  {{else if (eq user.role "admin")}}
    <div class="mb-20">
      <a href="/bookings/history" class="btn btn-secondary">View Bookings</a>
    </div>
  {{/if}}
{{/if}}

<div id="car-list">
  {{#each cars}}
    <div class="car-card">
      {{#if this.image_url}}
        <img src="{{this.image_url}}" alt="{{this.name}}" class="car-image" />
      {{/if}}
      <div class="car-details">
        <h3>{{this.name}}</h3>
        <p><strong>Description:</strong> {{{this.description}}}</p>
        <p><strong>Type:</strong> {{this.type}}</p>
        <p><strong>Color:</strong> {{this.color}}</p>
        <p><strong>Status:</strong> {{this.status}}</p>
        <p><strong>Price:</strong> {{this.price}} For {{this.base_rental_duration}} days</p>
        <p>Note: If booking exceeds {{this.base_rental_duration}} days, price increases by 20,000 per extra day.</p>
        <a href="/cars/{{this.id}}">View Details</a>
        {{#if (eq ../user.role "user")}}
          <div class="mt-10">
            <a href="/bookings/new?car_id={{this.id}}" class="btn btn-primary">Book This Car</a>
          </div>
        {{/if}}
      </div>
    </div>
  {{else}}
    <p>No cars available at the moment.</p>
  {{/each}}
</div>

<script>
  document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const color = document.getElementById('color').value;
    const type = document.getElementById('type').value;
    let query = '?';
    if (color) query += 'color=' + encodeURIComponent(color) + '&';
    if (type) query += 'type=' + encodeURIComponent(type) + '&';
    window.location.href = '/' + query.slice(0, -1);
  });
</script>
