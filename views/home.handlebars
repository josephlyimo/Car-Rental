<h2>Available Cars</h2>

<div>
  <form id="filterForm" autocomplete="off" style="margin-bottom: 20px;">
    <label for="color">Color:</label>
    <select id="color" name="color">
      <option value="" {{#unless filter.color}}selected{{/unless}}>All</option>
      <option value="red" {{#if (eq filter.color "red")}}selected{{/if}}>Red</option>
      <option value="blue" {{#if (eq filter.color "blue")}}selected{{/if}}>Blue</option>
      <option value="black" {{#if (eq filter.color "black")}}selected{{/if}}>Black</option>
      <option value="white" {{#if (eq filter.color "white")}}selected{{/if}}>White</option>
    </select>

    <label for="type">Type:</label>
    <select id="type" name="type">
      <option value="" {{#unless filter.type}}selected{{/unless}}>All</option>
      <option value="tour" {{#if (eq filter.type "tour")}}selected{{/if}}>Tour</option>
      <option value="ceremony" {{#if (eq filter.type "ceremony")}}selected{{/if}}>Ceremony</option>
      <option value="private" {{#if (eq filter.type "private")}}selected{{/if}}>Private</option>
    </select>

    <button type="submit">Filter</button>
  </form>

  <form id="searchForm" autocomplete="off" style="margin-bottom: 20px; position: relative;">
    <label for="searchInput">Search Cars:</label>
    <input type="text" id="searchInput" name="search" placeholder="Search cars...">
    <button type="submit">Search</button>
  <div id="suggestions" style="border: 1px solid #ccc; max-width: 300px; max-height: 150px; overflow-y: auto; display: none; position: absolute; background: white; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"></div>
  </form>

  <script>
    const searchInput = document.getElementById('searchInput');
    const suggestionsBox = document.getElementById('suggestions');
    const searchForm = document.getElementById('searchForm');

    searchInput.addEventListener('input', async () => {
      const query = searchInput.value.trim();
      console.log('Search input changed:', query);
      if (query.length === 0) {
        suggestionsBox.style.display = 'none';
        suggestionsBox.innerHTML = '';
        return;
      }
      try {
        const response = await fetch(`/cars/search-suggestions?q=${encodeURIComponent(query)}`);
        console.log('Fetch response status:', response.status);
        const suggestions = await response.json();
        console.log('Suggestions received:', suggestions);
        if (suggestions.length === 0) {
          suggestionsBox.style.display = 'none';
          suggestionsBox.innerHTML = '';
          return;
        }
        suggestionsBox.innerHTML = suggestions.map(s => `<div class="suggestion-item" style="padding: 5px; cursor: pointer;">${s}</div>`).join('');
        suggestionsBox.style.display = 'block';

        document.querySelectorAll('.suggestion-item').forEach(item => {
          item.addEventListener('click', () => {
            searchInput.value = item.textContent;
            suggestionsBox.style.display = 'none';
            suggestionsBox.innerHTML = '';
          });
        });
      } catch (err) {
        console.error('Error fetching suggestions:', err);
        suggestionsBox.style.display = 'none';
        suggestionsBox.innerHTML = '';
      }
    });

    document.addEventListener('click', (e) => {
      if (!suggestionsBox.contains(e.target) && e.target !== searchInput) {
        suggestionsBox.style.display = 'none';
        suggestionsBox.innerHTML = '';
      }
    });

    searchForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const query = searchInput.value.trim();
      if (query.length > 0) {
        window.location.href = `/search?query=${encodeURIComponent(query)}`;
      }
    });
  </script>
</div>

{{#if user}}
  {{#if (eq user.role "user")}}
    <div style="margin-bottom: 20px;">
      <a href="/bookings/new" class="btn btn-primary">Continue Booking</a>
    </div>
  {{else if (eq user.role "admin")}}
    <div style="margin-bottom: 20px;">
      <a href="/bookings/history" class="btn btn-secondary">View Bookings</a>
    </div>
  {{/if}}
{{/if}}

<div id="car-list">
  {{#each cars}}
    <div class="car-item">
      {{#if this.image_url}}
        <img src="{{this.image_url}}" alt="{{this.name}}" style="max-width: 200px; max-height: 150px;" />
      {{/if}}
      <h3>{{this.name}}</h3>
      <p>Description: {{{this.description}}}</p>
      <p>Type: {{this.type}}</p>
      <p>Color: {{this.color}}</p>
      <p>Status: {{this.status}}</p>
      <p>Price: {{this.price}} For {{this.base_rental_duration}} days</p>
      <p>Note: If booking exceeds {{this.base_rental_duration}} days, price increases by 20,000 per extra day.</p>
      <a href="/cars/{{this.id}}">View Details</a>
      {{#if (eq ../user.role "user")}}
        <div style="margin-top: 10px;">
          <a href="/bookings/new?car_id={{this.id}}" class="btn btn-primary">Book This Car</a>
        </div>
      {{/if}}
    </div>
  {{else}}
    <p>No cars available at the moment.</p>
  {{/each}}
</div>

<script>
  document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const color = document.getElementById('color').value;
    const type = document.getElementById('type').value;
    let query = '?';
    if (color) query += 'color=' + encodeURIComponent(color) + '&';
    if (type) query += 'type=' + encodeURIComponent(type) + '&';
    window.location.href = '/' + query.slice(0, -1);
  });
</script>
